# Декомпозиция задач: Этап 5 - Функционал администратора

Этот документ детализирует задачи, необходимые для завершения Этапа 5 "Функционал администратора" из основного плана разработки.

---

### 1. Создание защищенного роута и UI админ-панели

*Цель: Создать выделенную страницу для административных задач, доступную только пользователям с соответствующей ролью.*

- [ ] **Создать новый модуль `admin`:**
    - Создать директорию `src/modules/admin`.
    - Создать `src/modules/admin/README.md` с описанием назначения модуля.
- [ ] **Реализовать проверку роли администратора:**
    - Создать серверный компонент `/app/admin/page.tsx`.
    - В этом компоненте получить текущего пользователя с помощью `getCurrentUser` из модуля `auth`.
    - Если у пользователя нет роли `ADMIN`, выполнить редирект на главную страницу или показать сообщение об ошибке.
- [ ] **Создать компонент админ-панели:**
    - Создать клиентский компонент `src/modules/admin/components/AdminPanel.tsx`.
    - В компоненте разместить заголовок "Панель администратора".
    - Добавить две секции: "Экспорт данных" и "Импорт данных".
        - Секция экспорта должна содержать кнопку "Скачать резервную копию".
        - Секция импорта должна содержать поле для выбора файла (`<input type="file">`) и кнопку "Загрузить и заменить".

---

### 2. Реализация экспорта базы данных

*Цель: Дать администратору возможность скачать полную резервную копию базы данных.*

- [ ] **Создать серверное действие для экспорта:**
    - Создать файл `src/modules/admin/lib/actions.ts`.
    - Определить в нем асинхронную функцию `exportDb`.
    - Внутри `exportDb` снова проверить роль пользователя для безопасности.
    - Реализовать логику чтения файла базы данных (`dev.db`). Путь к файлу взять из переменной окружения `DATABASE_URL`.
    - Функция должна возвращать содержимое файла в виде `Buffer`.
- [ ] **Интегрировать с UI:**
    - В компоненте `AdminPanel.tsx` подключить действие `exportDb`.
    - При нажатии на кнопку "Скачать резервную копию" вызывать `exportDb`.
    - Получив `Buffer`, преобразовать его в `Blob` на клиенте и сгенерировать ссылку для скачивания файла с именем `backup.db`.
    - Добавить обработку состояния загрузки (например, деактивировать кнопку во время выполнения).

---

### 3. Реализация импорта базы данных

*Цель: Дать администратору возможность восстановить состояние базы данных из файла резервной копии.*

- [ ] **Создать серверное действие для импорта:**
    - В файле `src/modules/admin/lib/actions.ts` определить асинхронную функцию `importDb`, принимающую объект `FormData`.
    - Реализовать проверку роли пользователя.
    - Извлечь загруженный файл из `FormData`.
    - Реализовать логику, которая **полностью заменяет** текущий файл `dev.db` на загруженный.
    - **Важно:** Это деструктивная операция. Необходимо предусмотреть вывод четкого предупреждения в UI.
- [ ] **Интегрировать с UI:**
    - В `AdminPanel.tsx` обернуть секцию импорта в тег `<form>`.
    - Привязать к форме действие `importDb`.
    - Добавить `name` к полю `<input type="file">`, чтобы его можно было прочитать на сервере.
    - Добавить `confirm()` или модальное окно с предупреждением перед отправкой формы.
    - После успешного импорта перезагрузить страницу, чтобы приложение переподключилось к новой базе данных.
    - Реализовать отображение сообщений об успехе или ошибке.
