# Отчет: Этап 4.3 - Рефакторинг логики статистики

**Статус:** `Завершен`

---

## Цель

Изменить механизм подсчета статистики, чтобы он учитывал все попытки ответов, а не только факт одного правильного ответа. Реализовать отображение статистики для каждого отдельного вопроса.

---

## План действий

1.  **Изменение логики сохранения ответов (Модуль `quiz`):**
    -   **Действие:** Найти и модифицировать серверный экшен, отвечающий за сохранение ответа пользователя в `src/modules/quiz/lib/actions.ts`.
    -   **Логика:** Заменить текущую логику (вероятно, `update` или `upsert`) на безусловное создание (`create`) новой записи `AnswerResult` при каждом ответе.
    -   **Ожидаемый результат:** Каждая попытка ответа сохраняется в БД как отдельная запись.

2.  **Рефакторинг функций расчета статистики (Модуль `stats`):**
    -   **Действие:** Переписать функции в `src/modules/stats/lib/actions.ts`.
    -   **Логика:**
        -   Все расчеты должны теперь основываться на агрегации всех записей `AnswerResult`. Прогресс будет считаться как `(COUNT(correct_answers) / COUNT(all_answers)) * 100`.
        -   Переписать `getProgramsStats` и `getSectionsStats`, используя новый, более точный метод подсчета.
        -   Создать новую функцию `getQuestionsStats(sectionId, userId)`, которая будет возвращать статистику (общее число попыток, число верных) для каждого вопроса в рамках одного раздела.
    -   **Ожидаемый результат:** Функции статистики возвращают данные, рассчитанные на основе полной истории ответов.

3.  **Интеграция статистики по вопросам в UI (Модули `sections`, `questions`):**
    -   **Действие:** Модифицировать страницу раздела (`src/app/sections/[id]/page.tsx`) и компонент списка вопросов (`src/modules/questions/components/QuestionList.tsx`).
    -   **Логика:**
        -   На странице раздела вызвать новый экшен `getQuestionsStats`.
        -   Передать полученные данные в `QuestionList`.
        -   В `QuestionList` напротив каждого вопроса отобразить его статистику (например, "Верно: 5 из 8").
    -   **Ожидаемый результат:** Пользователь видит детальную статистику по каждому вопросу на странице раздела.

---

## Ход выполнения

-   **Логика сохранения ответов:** Проверена функция `submitAnswer` в `src/modules/quiz/lib/actions.ts`. Она уже корректно создает новую запись `AnswerResult` для каждого ответа, изменения не потребовались.
-   **Рефакторинг статистики:**
    -   Функции `getProgramsStats` и `getSectionsStats` в `src/modules/stats/lib/actions.ts` были полностью переписаны. Теперь они используют `prisma.aggregate` для эффективного подсчета всех попыток и правильных ответов.
    -   Добавлена новая функция `getQuestionsStats` для получения статистики по каждому вопросу.
    -   Компонент `ProgramHeader` был обновлен для совместимости с новой структурой данных статистики.
-   **Интеграция в UI вопросов:**
    -   На странице `src/app/sections/[id]/page.tsx` добавлен вызов `getQuestionsStats`.
    -   Компонент `QuestionList` был обновлен для приема и отображения статистики (X / Y, Z%) для каждого вопроса.

**Итог:** Механизм статистики полностью переработан. Теперь он учитывает все попытки, что дает более точное представление о прогрессе. Статистика доступна на уровне программ и отдельных вопросов.
