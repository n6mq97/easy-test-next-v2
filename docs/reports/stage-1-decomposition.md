# Декомпозиция задач: Этап 1 - Аутентификация

Этот документ детализирует задачи, необходимые для завершения Этапа 1 "Аутентификация" из основного плана разработки.

---

### 1. Установка и настройка NextAuth.js

*Цель: Интегрировать NextAuth.js в проект для управления сессиями и аутентификацией по имени и паролю.*

- [ ] **Установка зависимостей:** Установить `next-auth` и `bcryptjs` (для хеширования паролей): `npm install next-auth bcryptjs` и `@types/bcryptjs` для TypeScript.
- [ ] **Создание API-роута:** Создать файл `src/app/api/auth/[...nextauth]/route.ts` для размещения конфигурации NextAuth.js.
- [ ] **Конфигурация провайдера:** В файле `route.ts` настроить `CredentialsProvider` для аутентификации по логину и паролю.
- [ ] **Реализация логики `authorize`:** Внутри `CredentialsProvider` написать асинхронную функцию `authorize`, которая:
    - Принимает `credentials` (имя и пароль).
    - Находит пользователя в базе данных по имени.
    - Если пользователь найден, сравнивает хеш пароля из БД с хешем введенного пароля.
    - Возвращает объект пользователя в случае успеха или `null` в случае неудачи.
- [ ] **Настройка стратегии сессий:** Указать `strategy: 'jwt'` в основной конфигурации NextAuth.js.
- [ ] **Добавление переменных окружения:** Добавить `NEXTAUTH_URL` и `NEXTAUTH_SECRET` в файл `.env`. `NEXTAUTH_SECRET` можно сгенерировать.
- [ ] **Создание провайдера сессии:** Создать клиентский компонент-обертку `src/modules/auth/components/AuthProvider.tsx`, который будет содержать `<SessionProvider>` из `next-auth/react`.
- [ ] **Интеграция провайдера:** Обернуть дочерние элементы в корневом `src/app/layout.tsx` в созданный `AuthProvider`.

---

### 2. Реализация серверной логики (Server Actions)

*Цель: Создать серверные функции для регистрации пользователей и их поиска в базе данных.*

- [ ] **Создание файла для экшенов:** Создать файл `src/modules/auth/lib/actions.ts` для серверной логики.
- [ ] **Создание экшена регистрации `signUp`:**
    - Функция должна принимать `formData` из формы.
    - Проводить валидацию данных (имя и пароль не должны быть пустыми).
    - Проверять, существует ли пользователь с таким именем в БД. Если да, возвращать ошибку.
    - Хешировать пароль с помощью `bcryptjs`.
    - Создавать нового пользователя в БД, используя Prisma.
- [ ] **Создание экшена выхода `signOut`:**
    - Создать простую серверную функцию, которая вызывает `signOut` из `next-auth`.
- [ ] **Создание хелпера для получения сессии:**
    - Создать функцию `getCurrentUser`, которая получает текущую сессию на сервере.

---

### 3. Создание UI-компонентов

*Цель: Разработать React-компоненты для форм регистрации, входа и кнопки выхода.*

- [ ] **Компонент `SignUpForm` (`src/modules/auth/components/SignUpForm.tsx`):**
    - Создать клиентский компонент с формой, содержащей поля для имени и пароля.
    - Использовать Server Action `signUp` для обработки отправки формы.
    - Реализовать отображение сообщений об ошибках (например, "Пользователь уже существует").
- [ ] **Компонент `SignInForm` (`src/modules/auth/components/SignInForm.tsx`):**
    - Создать клиентский компонент с формой.
    - Использовать функцию `signIn` из `next-auth/react` с `provider: 'credentials'` для обработки отправки формы.
    - Реализовать отображение ошибок аутентификации (например, "Неверное имя или пароль").
- [ ] **Компонент `SignOutButton` (`src/modules/auth/components/SignOutButton.tsx`):**
    - Создать компонент с кнопкой, которая по клику вызывает Server Action `signOut`.

---

### 4. Создание страниц и защищенных роутов

*Цель: Организовать страницы для входа/регистрации и настроить защиту основного контента приложения.*

- [ ] **Создание публичных страниц:**
    - Создать страницу `src/app/login/page.tsx`, на которой разместить компонент `SignInForm`.
    - Создать страницу `src/app/register/page.tsx`, на которой разместить `SignUpForm`.
- [ ] **Настройка middleware (`src/middleware.ts`):**
    - Создать файл `middleware.ts` в корне проекта или в `src`.
    - Экспортировать в нем дефолтный `middleware` из `next-auth`.
    - Настроить `config.matcher`, чтобы middleware применялся ко всем роутам, кроме статических файлов и API-роута аутентификации.
- [ ] **Защита главной страницы:**
    - На главной странице (`src/app/page.tsx`) проверить наличие сессии.
    - Если сессии нет, пользователь будет автоматически перенаправлен на страницу входа (это поведение `NextAuth.js middleware` по умолчанию).
    - Если сессия есть, отображать приветственное сообщение и компонент `SignOutButton`.
